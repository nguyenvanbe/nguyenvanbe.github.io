<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<meta name="google" content="notranslate">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<script src="js/jquery.min.js"></script>

	<style type="text/css">
			*, div {
		  box-sizing: border-box;
		  font-family: sans-serif;
		  text-align: center;
		}
		.modal-container:before {
		  content: "";
		  background-color: rgba(0, 0, 0, 0.6);
		  display: block;
		  position: fixed;
		  top: 0;
		  left: 0;
		  bottom: 0;
		  right: 0;
		}
		.modal-container:closed {
		  display: none;
		}

		.modal {
		  position: fixed;
		  top: 50px;
		  left: 0px;
		  right: 0px;
		  margin: 0 auto;
		  display: block;
		  background: white;
		  padding: 10px;
		  width: 600px;
		  max-width: 100%;
		  z-index: 1;
		}

		button {
		  border: none;
		  background-color: #008CBA;
		  font-weight: bold;
		  color: white;
		  font-size: 14px;
		  padding: 15px;
		  cursor: pointer;
		  float: right;
		  outline: none;
		}
		button:hover {
		  background-color: #66b3ff;
		}


		html {
			height: 100%;
		}
		body {
			margin: 2px;
			background-image: url('images/Background.png');
			background-repeat: no-repeat;
			background-attachment: fixed;
			background-size: 100% 100%;
			height: 100sh;
			width: 100%;
			touch-action: none;
		}
		@media only screen and (orientation:landscape) {
			body {
				height: 100vw;
			}
		}
		.centered-element {
			margin: 0;
			position: fixed;
			top: 50%;
			left: 50%;
			-ms-transform: translate(-50%, -50%);
			transform: translate(-50%, -50%);
		}		
	</style>
</head>
<body oncontextmenu="return false;" onselectstart="return false" overscroll-behavior-y: contain;>
<div id="container" style="width: 100%; float:center;" align="center" class="centered-element">
	<!--canvas id="dpadCanvas" width="360" height="720" style="border:solid yellow 1px;"-->
	<!-- <canvas id="dpadCanvas" width="360" height="720" style="border:solid #080D11 1px;"> -->
		<canvas id="dpadCanvas" width="360" height="720">
</div>
<div id="container" style="width: 100%; float:center;" align="center" class="centered-element">
<p id="debug">debug text</p>
</div>
<div  class="modal-container" id="modal" style="display: block;">	
	<div class="modal">
		<h2>Connection lost</h2>
		<p>Please check your wifi connection and re-scan the barcode.</p>
		<button id="gotit">OK</button>
	</div>
</div>
<script>
$("#modal").hide();

			//----------------- Queue Clase -----------------//
			class Queue {
				constructor() {
					this.items = [];
					this.items = [];
				}				 
				
				enqueue(action, element) {
					return this.items.push({action, element});
				}				
				
				dequeue() {
					if(this.items.length > 0) {
						return this.items.shift();
					}
				}				
				
				peek() {
					return this.items[0].element;					
				}
								
				action() {
					return this.items[0].action;
				}
				
				isEmpty(){
					return this.items.length == 0;
				}
								
				size(){
					 return this.items.length;
				}			 
								
				clear(){
					this.items = [];
				}
			}
			//----- Connect Server -----//
			let connected = 0;
			let ws;

			function connectServer() {
				let host = document.getElementById("hostAddress").value;
				let port = "12345";
				let hostPortWS = "ws://" + host + ":" + port;
				ws = new WebSocket(hostPortWS);
				ws.addEventListener("open", () => {
				  //console.log("We are connected!");
				  connected = 1;
				})
				ws.addEventListener("message", e => {
				  //console.log(e);
				});
				ws.addEventListener("close", e => {
				  //console.log(e);
				  connected = 0;
				});
				ws.addEventListener("error", e => {
				  //console.log(e);
				});
			}

			const http = new XMLHttpRequest()
			const httpDpadUp = new XMLHttpRequest()
			const httpDpadDown = new XMLHttpRequest()
			const httpActionUp = new XMLHttpRequest()
			const httpActionDown = new XMLHttpRequest()
			const queue = new Queue();
			let isCheckConnection = false;
			function pingIn() {
				if (!isCheckConnection)
				{
					isCheckConnection = true;
					new Promise(function (resolve, reject) {
					try {
						var xhr = new XMLHttpRequest();
						xhr.open("GET",window.location + "PingIn",true);
						xhr.timeout = 2000; // time in milliseconds
						xhr.responseType = "text";
						xhr.send();
						xhr.onload = function () {
							if (xhr.status == 200) {
								isCheckConnection = false;
								var words = xhr.responseText.split(" ");
								if(words[0]=="MN")
								{	
									isMenuMode=true;
								}
								if(words[0]=="AP")
									isMenuMode=false;

								ChangeUITouchDrive(words[1]);	// feedback for TouchDrive
								if(isLastMenuMode!= isMenuMode )
								{
									isLastMenuMode = isMenuMode;
									ChangeUI(isMenuMode);
								}
								return resolve(xhr.responseText);
							} else {								
								return reject(disconnect());
							}
						}
						xhr.ontimeout = (e) => {
							disconnect();
						};
						xhr.onerror = (e) => {
							disconnect();
						};
						} catch(Exception ){
							disconnect();
						}
					});
				}
			}

			function disconnect() {
				console.log("disconnect");	
				$("#modal").show("before");
				$("button").on("click", function(){
					$("#modal").fadeOut();
					isCheckConnection = false;
				});
				$(".modal-container").on("click", function(){
					isCheckConnection = false;
					$("#modal").fadeOut();
				});
			}
			function threadPingIn() {
				pingIn();
				setTimeOut(threadPingIn, 500);
			}
			
			function sendActionUp(a) {
				console.log("sendActionUp");				
				queue.enqueue(4, a);						
			}
			
			function sendActionDown(a) {
				console.log("sendActionDown");				
				queue.enqueue(3, a);
			}
			
			function sendDpadUp(a) {
				console.log("sendDpadUp");			
				queue.enqueue(2, a);
			}
			
			function sendDpadDown(a) {
				console.log("sendDpadDown");
				dpadKeycodeCurrent = a;				
				queue.enqueue(1, a);
				//window.navigator.vibrate(25); // Not run on Iphone
			}

			function sendJoystick(x, y, speed, angle) {			
				var data = [x, y, "android"];
				if (getOperatingSystemIOS()=="iOS")
				{
					if (isPortraitIOS())
						data = [y, -x, "ios-p"];
					else
						data = [x, y, "ios-l"];
				}
				else
				{
					if (isLandscapeMode())
						data = [x, y, "android-l"];
					else
						data = [y, -x, "android-p"];
				}
				http.open("GET", window.location + "ActionJoystick/" + data.toString(),true);
				http.send();
			}

			function isConnection() {
				if (connected != 1) {
					//console.log("Connection Checking");
				}
			}
			
			function doActionInQueue() {				
				while (!queue.isEmpty()) {					
					//console.log("Queue item: " + queue.peek());					
					if (queue.action() == 1){ //DpadDown
						if (window.Promise) {
							var promise = new Promise(function(resolve, reject) {							
								httpDpadDown.open("GET", window.location + "DpadDown/" + queue.peek(), true);
								httpDpadDown.onload= function() {
									if (httpDpadDown.status == 200) {
										if(httpDpadDown.responseText=="MN")
										{
											isMenuMode=true;
										}
										if(httpDpadDown.responseText=="AP")
											isMenuMode=false;
										if(isLastMenuMode!= isMenuMode )
										{
											isLastMenuMode = isMenuMode;
											ChangeUI(isMenuMode);
										}
										resolve(httpDpadDown.response);
									} else {
										reject(Error(httpDpadDown.statusText));
									}
								};
								
								httpDpadDown.onerror = function() {
									reject(Error('Error fetching data. Reject the Promise'));
								};
								
								httpDpadDown.send();
							
							});
									// for check status
															promise.then(function(data) {
									console.log('Got data! Promise fulfilled.');								
								}, function(error) {
									console.log('Promise rejected.');
									console.log(error.message);
								});
						} else {
							console.log('Promise not available');
						}
						/*httpDpadDown.onreadystatechange = function () {
							if (httpDpadDown.status == 200 && httpDpadDown.readyState == 4) {
								callback(httpDpadDown.responseText);							
							}						
						};
						httpDpadDown.open("GET", window.location + "ActionDown/" + queue.peek(), true);*/
					} else if (queue.action() == 2){ //DpadUp
						if (window.Promise) {
							var promise = new Promise(function(resolve, reject) {							
								httpDpadUp.open("GET", window.location + "DpadUp/" + queue.peek(), true);
								httpDpadUp.onload= function() {
									if (httpDpadUp.status == 200) {
										resolve(httpDpadUp.response);
									} else {
										reject(Error(httpDpadUp.statusText));
									}
								};
								
								httpDpadUp.onerror = function() {
									reject(Error('Error fetching data. Reject the Promise'));
								};
								
								httpDpadUp.send();
								

							});
							// for check status
															promise.then(function(data) {
									console.log('Got data! Promise fulfilled.');								
								}, function(error) {
									console.log('Promise rejected.');
									console.log(error.message);
								});
						} else {
							console.log('Promise not available');
						} //End window.Promise
						
						/*httpDpadUp.onreadystatechange = function () {
							if (httpDpadUp.status == 200 && httpDpadUp.readyState == 4) {
								callback(httpDpadUp.responseText);							
							}						
						};
						httpDpadUp.open("GET", window.location + "ActionUp/" + queue.peek(), true);						
						httpDpadUp.send();*/
					} else if (queue.action() == 3){ //ActionDown
						httpActionDown.onreadystatechange = function () {
							if (httpActionDown.status == 200 && httpActionDown.readyState == 4) {
								callback(httpActionDown.responseText);
							}						
						};
						httpActionDown.open("GET", window.location + "ActionDown/" + queue.peek(), true);						
						httpActionDown.send();
					} else if (queue.action() == 4){ //ActionUp
						httpActionUp.onreadystatechange = function () {
							if (httpActionUp.status == 200 && httpActionUp.readyState == 4) {
								callback(httpActionUp.responseText);
							}						
						};
						httpActionUp.open("GET", window.location + "ActionUp/" + queue.peek(), true);						
						httpActionUp.send();
					}
					
					queue.dequeue();
				}
				if (queue.isEmpty())
					queue.clear();				
			}

			//----- Keycode constants -----//
			const KEYCODE_DPAD_UP		= 19;
			const KEYCODE_DPAD_DOWN		= 20;
			const KEYCODE_DPAD_LEFT		= 21;
			const KEYCODE_DPAD_RIGHT	= 22;
			const KEYCODE_DPAD_UP_LEFT		= 268;
			const KEYCODE_DPAD_DOWN_LEFT	= 269;
			const KEYCODE_DPAD_UP_RIGHT		= 270;
			const KEYCODE_DPAD_DOWN_RIGHT	= 271;

			const KEYCODE_BUTTON_A		= 96;
			const KEYCODE_BUTTON_B		= 97;
			const KEYCODE_BUTTON_X		= 99;
			const KEYCODE_BUTTON_Y		= 100;
			const KEYCODE_BUTTON_L1		= 102;
			const KEYCODE_BUTTON_R1		= 103;
			const KEYCODE_BUTTON_L2		= 104;
			const KEYCODE_BUTTON_R2		= 105;
			const KEYCODE_BUTTON_START	= 108;
			const KEYCODE_BUTTON_SELECT = 109;
			const KEYCODE_BUTTON_MODE 	= 110;


			//Define new value for release event (+500)
			const KEYCODE_DPAD_UP_RELEASE		= 19;
			const KEYCODE_DPAD_DOWN_RELEASE		= 20;
			const KEYCODE_DPAD_LEFT_RELEASE		= 21;
			const KEYCODE_DPAD_RIGHT_RELEASE	= 22;
			const KEYCODE_DPAD_UP_LEFT_RELEASE		= 268;
			const KEYCODE_DPAD_DOWN_LEFT_RELEASE	= 269;
			const KEYCODE_DPAD_UP_RIGHT_RELEASE		= 270;
			const KEYCODE_DPAD_DOWN_RIGHT_RELEASE	= 271;

			const KEYCODE_BUTTON_A_RELEASE		= 96;
			const KEYCODE_BUTTON_B_RELEASE		= 97;
			const KEYCODE_BUTTON_X_RELEASE		= 99;
			const KEYCODE_BUTTON_Y_RELEASE		= 100;
			const KEYCODE_BUTTON_L1_RELEASE		= 102;
			const KEYCODE_BUTTON_R1_RELEASE		= 103;
			const KEYCODE_BUTTON_L2_RELEASE		= 104;
			const KEYCODE_BUTTON_R2_RELEASE		= 105;
			const KEYCODE_BUTTON_START_RELEASE	= 108;
			const KEYCODE_BUTTON_SELECT_RELEASE = 109;
			const KEYCODE_BUTTON_MODE_RELEASE 	= 110;


			//----- Variables, Array... -----//
			var imgDpadNormal, imgDpadBG;
			var imgDpadLeft, imgDpadRight, imgDpadUp, imgDpadDown;
			var imgDpadUpLeft, imgDpadUpRight, imgDpadDownLeft, imgDpadDownRight;
			var imgJoystickBG, imgJoystick, imgJoystickP;
			var imgActionX, imgActionY, imgActionA, imgActionB;
			var imgActionXP, imgActionYP, imgActionAP, imgActionBP;
			var imgActionL1, imgActionR1, imgActionL2, imgActionR2;
			var imgActionL1P, imgActionR1P, imgActionL2P, imgActionR2P;
			var imgStart, imgStartP, imgSelect, imgSelectP;
			var imgLockPortrait, imgLockPortraitP;
			//----- dpad button -----//
			var canvasW, canvasH;
			var dpadArea = new Array;
			var dpadPosX, dpadPosY, arrowW, arrowH;
			//----- action button -----//
			var actionArea = new Array;
			var actionPosX, actionPosY, actionW, actionH;
			var actionLRPosX, actionLRPosY, actionLRW, actionLRH, actionSpace;
			var actionSpaceX, actionSpaceY;
			//----- function button -----//
			var functionPosX, functionPosY, functionW, functionH;
			var lockScreenW, lockScreenH;
			//----- joystick -----//
			var radius, x_orig, y_orig;
			//----- touch -----//
			var touchesAction = [];
			var joystickActive = false;
			var isLocked = !false;
			var currentWidth;
			//var isRotated=false;
			var isReloaded=false;
            //------Asphal9 Geely-----/
			var isMenuMode = !true; 
			var isLastMenuMode = true;
			var isTouchDrive =false

			var  actionAreaMenu = new Array;
			var  actionAreaAP = new Array;
			var  dpadAreaMenu = new Array;
			var imgDpadNormalA9;
			var imgDpadDownPressedA9,imgDpadLeftPressedA9,imgDpadRightPressedA9,imgDpadUpPressedA9;
			var imgCamera, imgCameraP, imgTouchDrive,imgTouchDriveP;
			var dpadKeycodeCurrent = 0;

			var debug = document.getElementById("debug");
			var el = document.getElementById("dpadCanvas");
			var ctx = el.getContext("2d");

			function initArray() {
				if ((getOperatingSystem()=="iPad") ||(getOperatingSystem()=="Macintosh"&& isLandscapeIOS())|| ((getOperatingSystem()=="iPhone") && isLandscapeIOS()) || ((getOperatingSystem()=="Android"||getOperatingSystem()=="Desktop" )&& (canvasW>canvasH))) {
					dpadArea = [
						[{x:dpadPosX, y:dpadPosY, active:false}, 			{x:(dpadPosX+arrowW), y:dpadPosY, active:false}, 			{x:(dpadPosX+arrowW*2), y:dpadPosY, active:false}],
						[{x:dpadPosX, y:(dpadPosY+arrowH), active:false}, 	{x:(dpadPosX+arrowW), y:(dpadPosY+arrowH), active:false}, 	{x:(dpadPosX+arrowW*2), y:(dpadPosY+arrowH), active:false}],
						[{x:dpadPosX, y:(dpadPosY+arrowH*2), active:false}, {x:(dpadPosX+arrowW), y:(dpadPosY+arrowH*2), active:false}, {x:(dpadPosX+arrowW*2), y:(dpadPosY+arrowH*2), active:false}]
					];

					actionArea = [
						{x:canvasW-actionSpaceX-(actionW*2), y:actionPosY+(actionSpaceY*2), w:actionW, h:actionH, active:false}, //[0] X
						{x:canvasW-actionSpaceX-actionW, y:actionPosY, w:actionW, h:actionH, active:false},        					//[1] Y
						{x:canvasW-actionSpaceX-actionW, y:actionPosY+(actionSpaceY*4), w:actionW, h:actionH, active:false},   	//[2] A
						{x:canvasW-actionSpaceX, y:actionPosY+(actionSpaceY*2), w:actionW, h:actionH,  active:false}, 				//[3] B
						{x:actionLRPosX+actionLRW+5, y:actionLRPosY, w:actionLRW,h:actionLRH,active:false},					//[4] L1 Bumper
						{x:canvasW-(actionLRW*2)-actionLRPosX-5,y:actionLRPosY, w:actionLRW,h:actionLRH,active:false},	//[5] R1 Bumper
						{x:actionLRPosX, y:actionLRPosY, w:actionLRW,h:actionLRH,active:false},					 				//[6] L2 LTrigger
						{x:canvasW-actionLRW-actionLRPosX, y:actionLRPosY, w:actionLRW,h:actionLRH,active:false}, 		//[7] R2 RTrigger
						{x:canvasW/2-functionPosX-80, y:functionPosY, w:functionW, h:functionH, active:false}, 			//[8] Start
						{x:canvasW/2-functionPosX+80, y:functionPosY, w:functionW, h:functionH, active:false}, 			//[9] Select
						{x:canvasW/2-lockScreenW/2, y:canvasH/2-lockScreenH/2, w:lockScreenW, h:lockScreenH, active:false}, 		//[10] Rotate
					  ];
					//Asphalt 9
					actionAreaMenu = [
							{x:canvasW-actionPosX-Math.round(actionW*4.8), y:canvasH-actionPosY- Math.round(2.5* actionH) , w:actionW+ Math.round(actionW*1/4), h:actionH +Math.round(actionH*1/4), active:false}, 				//[0] X
							{x:canvasW-actionLRW*2-actionLRPosX, y:actionLRPosY, w:actionW, h:actionH , active:false}, 	//[1] y

							{x:canvasW-actionPosX-Math.round(actionW*6.2), y:canvasH-actionPosY- Math.round(actionH*1.2) , w:actionW*2+ Math.round(actionW*3/4), h:actionH*2 +Math.round(actionH*3/4), active:false}, 				//[2] A
							{x:canvasW-actionPosX-Math.round(actionW*3.5), y:canvasH-actionPosY - Math.round(2.5* actionH), w:actionW*2, h:actionH*2 , active:false}, 	//		//[3] B

							{x:Math.round(canvasW/2-actionW/2), y:actionLRPosY, w:actionW, h:actionH, active:false}, 					//[4] Camera
							{x:dpadPosX, y:actionLRPosY, w:actionW*2, h:actionH , active:false}, 	//[5] Touch Drive

							{x:canvasW/2-lockScreenW/2, y:canvasH/2-lockScreenH/2, w:lockScreenW, h:lockScreenH, active:false}, 		//[6 Rotate
					  ];
					  dpadAreaMenu = [
						[{x:dpadPosX, y:dpadPosY, active:false}, 			{x:(dpadPosX+arrowW), y:dpadPosY, active:false}, 			{x:(dpadPosX+arrowW*2), y:dpadPosY, active:false}],
						[{x:dpadPosX, y:(dpadPosY+arrowH), active:false}, 	{x:(dpadPosX+arrowW), y:(dpadPosY+arrowH), active:false}, 	{x:(dpadPosX+arrowW*2), y:(dpadPosY+arrowH), active:false}],
						[{x:dpadPosX, y:(dpadPosY+arrowH*2), active:false}, {x:(dpadPosX+arrowW), y:(dpadPosY+arrowH*2), active:false}, {x:(dpadPosX+arrowW*2), y:(dpadPosY+arrowH*2), active:false}]
					];

				} else {// doc
					dpadArea = [
						[{x:dpadPosX, y:dpadPosY, active:false}, {x:(dpadPosX+arrowW), y:dpadPosY, active:false}, {x:(dpadPosX+arrowW*2), y:dpadPosY, active:false}],
						[{x:dpadPosX, y:(dpadPosY+arrowH), active:false}, {x:(dpadPosX+arrowW), y:(dpadPosY+arrowH), active:false}, {x:(dpadPosX+arrowW*2), y:(dpadPosY+arrowH), active:false}],
						[{x:dpadPosX, y:(dpadPosY+arrowH*2), active:false}, {x:(dpadPosX+arrowW), y:(dpadPosY+arrowH*2), active:false}, {x:(dpadPosX+arrowW*2), y:(dpadPosY+arrowH*2), active:false}]
					];
					actionAreaMenu = [
							{x:canvasW-actionPosX+Math.round(actionW*0.2), y:canvasH-actionPosY - Math.round(actionH*1.6) , w:actionW+ Math.round(actionW*1/4), h:actionH +Math.round(actionH*1/4), active:false}, 				//[0] X
							{x:canvasW-actionLRPosX, y:canvasH-actionLRPosY, w:actionW, h:actionH , active:false}, 	//[1] y		

							{x:canvasW-actionPosX-Math.round(actionW*1.1), y:canvasH-actionPosY - actionH*3 , w:actionW*2+ Math.round(actionW*3/4), h:actionH*2 +Math.round(actionH*3/4), active:false}, 				//[1] A
							{x:canvasW-actionPosX+Math.round(actionW*0.2), y:canvasH-actionPosY - Math.round(actionH/4), w:actionW*2, h:actionH*2 , active:false}, 	//[2] B		
							
							{x:canvasW-actionLRPosX, y:Math.round(canvasH/2-actionW/2), w:actionW, h:actionH, active:false}, 				//[4] Camera
							{x:canvasW-actionLRPosX, y:dpadPosY, w:Math.round(actionW*1.67), h:actionH , active:false}, 	//[5] Touch Drive
							{x:Math.round(canvasW/2-lockScreenW/2), y:Math.round(canvasH/2-lockScreenH/2), w:lockScreenW, h:lockScreenH, active:false}, 		//[6] Rotate
					  ];
					actionArea = [
						{x:canvasW-actionPosX-(actionW*1.7), y:canvasH-actionPosY-actionH+5, w:actionW, h:actionH, active:false}, 	//[0] X
						{x:canvasW-actionPosX-actionW, y:canvasH-actionPosY, w:actionW, h:actionH, active:false}, 						//[1] Y
						{x:canvasW-actionPosX-(actionW*2.4), y:canvasH-actionPosY, w:actionW, h:actionH, active:false}, 				//[2] A
						{x:canvasW-actionPosX-(actionW*1.7), y:canvasH-actionPosY+actionH-5, w:actionW, h:actionH, active:false}, 	//[3] B
						{x:canvasW-actionLRPosX, y:actionLRPosY+actionSpace, w:actionLRW, h:actionLRH, active:false}, 						//[4] L1
						{x:canvasW-actionLRPosX, y:canvasH-actionLRPosY-actionLRW-actionSpace,w:actionLRW, h:actionLRH, active:false}, //[5] R1
						{x:canvasW-actionLRPosX, y:actionLRPosY-actionLRW, w:actionLRW, h:actionLRH, active:false}, 							//[6] L2
						{x:canvasW-actionLRPosX, y:canvasH-actionLRPosY, w:actionLRW, h:actionLRH, active:false}, 							//[7] R2
						{x:canvasW-functionPosX, y:(canvasH/2)-functionPosY-(functionW/2), w:functionW, h:functionH, active:false}, 	//[8] Start
						{x:canvasW-functionPosX, y:(canvasH/2)+functionPosY-(functionW/2), w:functionW, h:functionH, active:false}, 	//[9] Select
						{x:canvasW/2-lockScreenW/2, y:canvasH/2-lockScreenH/2, w:lockScreenW, h:lockScreenH, active:false}, 				//[10] Rotate
					];
				}
			}

			function initVariables() {
				initVariablesRatio(1);
				if (getOperatingSystem()=="Android") {
					let screenRatio = window.devicePixelRatio || 1;
					let w = screen.width * screenRatio;
					let h = screen.height * screenRatio;
					let specificRatio = w/h;
					if((specificRatio>1.95&&specificRatio<2.2)||(1/specificRatio>1.95&&1/specificRatio<2.2))
						initVariablesRatio(0.8);
					if ((w<h && h<820) || (w>h && w<820)) {
						initVariablesRatio(0.85);
					} else if ((w<h && h<1000) || (w>h && w<1000)) {
						initVariablesRatio(0.95);
					}
					if (browserDetect() == "opera") {
						if (w<h && h<2000)
							initVariablesRatio(0.9);
					}
				}
			}

			function initVariablesRatio(scrRatio) {
				var ratio = scrRatio;
				let canvas = document.getElementById("dpadCanvas");
				if ((getOperatingSystem()=="iPad")||(getOperatingSystem()=="Macintosh")  || ((getOperatingSystem()=="iPhone") && isLandscapeIOS())) {
					if (isPortraitIOS()) {
						canvas.width = screen.width;
						canvas.height = screen.height;
					} else {
						canvas.width = screen.height;
						canvas.height = screen.width;
					}
				} else if (getOperatingSystem()=="iPhone") {
					canvas.width = screen.width;
					canvas.height = screen.height-190;
				} else {
					canvas.width = window.outerWidth;
					canvas.height = window.outerHeight;
					if (getOperatingSystem()=="Android") {
						if (screen.width>screen.height) {
							canvas.height = screen.height;
						}
						let screenRatio = window.devicePixelRatio || 1;
						let w = screen.width * screenRatio;
						let h = screen.height * screenRatio;
						if ((w<h && h<1000) || (w>h && w<1000)) {
							canvas.width = screen.width;
							canvas.height = screen.height;
						}
					}
				}
				canvasW = canvas.width;
				canvasH = canvas.height;

				if ((getOperatingSystem()=="iPad")||(getOperatingSystem()=="Macintosh"&& isLandscapeIOS())  || ((getOperatingSystem()=="iPhone") && isLandscapeIOS()) ||((getOperatingSystem()=="Android"||getOperatingSystem()=="Desktop" ) && (canvasW>canvasH))) {
					dpadPosX=80, dpadPosY=canvasH-275*ratio, arrowW=70*ratio, arrowH=70*ratio;
					actionPosX=-50, actionPosY=135*ratio, actionW=70*ratio, actionH=70*ratio;
					actionSpaceX=90, actionSpaceY=26;
					actionLRPosX=25, actionLRPosY=25, actionLRW=60*ratio, actionLRH=70*ratio;
					functionPosX=30, functionPosY=90, functionW=60*ratio, functionH=40*ratio;
					lockScreenW=140; lockScreenH=140;
					radius=60*ratio; x_orig=dpadPosX +arrowW*1.5 ; y_orig=dpadPosY +arrowH*1.5;

					if(getOperatingSystem()=="iPhone" ||getOperatingSystem()=="iPad"||getOperatingSystem()=="Macintosh")
					{
						let screenRatio = window.devicePixelRatio || 1;
					let w = screen.width * screenRatio;
					let h = screen.height * screenRatio;
					let specificRatio = w/h;

						if(specificRatio<0.6||getOperatingSystem()=="Macintosh"&&specificRatio<0.6)
						{
							dpadPosX=20;dpadPosY=canvasH-330*ratio;arrowW=65*ratio, arrowH=65*ratio;
							actionPosX = -90;actionPosY=170*ratio;
							radius=55*ratio; x_orig=dpadPosX +arrowW*1.5 ; y_orig=dpadPosY +arrowH*1.5;
							if(getOperatingSystem()=="Macintosh")
							{
								actionLRPosX=-50;
								actionW=60*ratio, actionH=60*ratio;
								arrowW=65*ratio, arrowH=65*ratio;
								dpadPosY=canvasH-275*ratio;
								radius=58*ratio;

							}
						}
						else if(getOperatingSystem()=="Macintosh"&&specificRatio<0.8)
						{
							dpadPosX=20;dpadPosY=canvasH-400*ratio
							actionPosX = -120;actionPosY=210*ratio;
							if(specificRatio<0.7)
							{
								dpadPosY=canvasH-420*ratio;actionPosY=280*ratio;
							}
						} else if(getOperatingSystem()=="iPad")
						{
							dpadPosY=canvasH-350*ratio;actionPosY=210*ratio;
							if(specificRatio<0.7)
							{
								dpadPosY=canvasH-420*ratio;actionPosY=280*ratio;
							}
						}
						x_orig=dpadPosX +arrowW*1.5 ; y_orig=dpadPosY +arrowH*1.5;

						//Jackauk : check dimension of object to decrease them to avoid buttons are overlay
						//1. Joystick vs TouchDrive button
						if( (actionLRPosY + actionH) > (dpadPosY - arrowH))
						{
							dpadPosY = dpadPosY  + actionLRPosY + actionH - (dpadPosY - arrowH);
							y_orig=dpadPosY +arrowH*1.5;
							actionW = 55*ratio;arrowW= 63*ratio;actionH = 55*ratio;
						}
						//2. back button vs edge+
						//x:canvasW-actionPosX-Math.round(actionW*3.5), y:canvasH-actionPosY - Math.round(2.5* actionH), w:actionW*2, h:actionH*2 , active:false},
						//if( (actionPosX + Math.round(actionW*1.5)  )  > 0 )
						{
						//	actionPosX = actionPosX - (actionPosX + Math.round(actionW*1.5) -10)  ;
							actionPosX = actionPosX + 100  ;
						}
					}
					
				} else {
					//dpadPosX=canvasW-(55*4)-100; dpadPosY=15; arrowW=60*ratio; arrowH=60*ratio;
					dpadPosX=50; dpadPosY=40; arrowW=70*ratio; arrowH=70*ratio;
					//actionPosX=85; actionPosY=155; actionW=70*ratio; actionH=70*ratio;
					actionPosX=canvasW-280*ratio; actionPosY=150*ratio; actionW=70*ratio; actionH=70*ratio;
					actionLRPosX=30; actionLRPosY=85; actionLRW=60*ratio; actionLRH=70*ratio; actionSpace=10*ratio;
					functionPosX=90; functionPosY=90; functionW=70*ratio; functionH=34*ratio;
					lockScreenW=140; lockScreenH=140;

					radius=60*ratio; x_orig=dpadPosX +arrowW*1.5 ; y_orig=dpadPosY +arrowH*1.5;
					if(getOperatingSystem()=="iPhone"||getOperatingSystem()=="iPad"||getOperatingSystem()=="Macintosh")
					{
						let screenRatio = window.devicePixelRatio || 1;
						let w = screen.width * screenRatio;
						let h = screen.height * screenRatio;
						let specificRatio = w/h;

						if(specificRatio<0.6||getOperatingSystem()=="Macintosh"&&specificRatio<0.6)
						{
							dpadPosY=30;
							actionPosY=130*ratio;
							actionW=58*ratio; actionH=58*ratio;
							arrowW=60*ratio; arrowH=60*ratio;
							radius=55*ratio; 
							if(getOperatingSystem()=="Macintosh")
							{
								actionPosY=250*ratio;
								actionLRPosY = 175;
							}
						}
						else if(getOperatingSystem()=="Macintosh"&&specificRatio<0.8)
						{
							dpadPosY=40;
							dpadPosX = 90;
							actionPosY=220*ratio;actionPosX=canvasW-280*ratio
							actionLRPosY = 175;
							if(specificRatio<0.7)
							{
								actionPosY=250*ratio;
								actionPosX=canvasW-400*ratio;
								actionLRPosX=-30;
							}
							
						}
						else if(getOperatingSystem()=="iPad")
						{
							dpadPosY=40;actionPosY=200*ratio;
							if(specificRatio<0.7)
							{
								dpadPosY=90;
								actionPosY=290*ratio;
								dpadPosX = 90;
							}
						}
						x_orig=dpadPosX +arrowW*1.5 ; y_orig=dpadPosY +arrowH*1.5;
					}

					//radius=30*ratio; x_orig=canvasW-(170+100*ratio); y_orig=280*ratio;
					

					
				}
			}

			//----------------- Control -----------------//
			function handleClick(event) {
				console.log("handleClick isLocked=" + isLocked);
				// JackAuk lock Ios on potrait
				if ((getOperatingSystem()=="iPad" ||getOperatingSystem()=="Macintosh"|| getOperatingSystem()=="iPhone") && !isLandscapeIOS())
					{
						return;
					}
				// if (!checkResize())
				// return;
				var x = event.pageX - el.getBoundingClientRect().left;
				var y = event.pageY - el.getBoundingClientRect().top;
				//if (!isLocked && (getOperatingSystem()!="iPad" || getOperatingSystem()!="iPhone"|| getOperatingSystem()!="Macintosh")) {
				//	if ((x > actionAreaMenu[6].x) && (x < actionAreaMenu[6].x + actionAreaMenu[6].w) && (y > actionAreaMenu[6].y) && (y <actionAreaMenu[6].y + actionAreaMenu[6].h)) {
						console.log("lockFullscreen");
						lockFullscreen();						
				//	}
				//}
			}

			function handleStart(event) {
				// JackAuk lock Ios on potrait
				if ((getOperatingSystem()=="iPad" ||getOperatingSystem()=="Macintosh"|| getOperatingSystem()=="iPhone") && !isLandscapeIOS())
				{
					return;
				}

				var x = event.changedTouches[0].pageX - el.getBoundingClientRect().left;
				var y = event.changedTouches[0].pageY - el.getBoundingClientRect().top;

				if (isLocked)
				{
					event.preventDefault();
					var changedTouches = event.changedTouches;
					for (var i = 0; i < changedTouches.length; i++) {
						var touch = changedTouches[i];
						var btnId = -1;
						var pX=touch.pageX-el.getBoundingClientRect().left;
						var pY=touch.pageY-el.getBoundingClientRect().top;
						for (var j=0; j<(actionAreaMenu.length-1); j++) {
							 if(isMenuMode&& (j!=2 && j!=3)) // Mode Menu  doesn't have  these buttons.
							  continue; 
							if  (getOperatingSystem()=="Macintosh"&& isLandscapeIOS() && (canvasW>canvasH))
							{
						//		pY = pY-actionW*2+ Math.round(actionW*3/4);
							}
							if (!actionAreaMenu[j].active && isInsideActionRect(pX, pY, j)) {
								btnId = j;
								//console.log("handleStart!!! btnId "+ btnId);
								doActionPressed(j);
							//	window.navigator.vibrate(25);// Not run on Iphone
								touchesAction.push({ id: changedTouches[i].identifier, buttonId: btnId});
								return;
							}
						}
					}
				}

			}

			function handleMove(event) {
				var x = event.changedTouches[0].pageX - el.getBoundingClientRect().left;
				var y = event.changedTouches[0].pageY - el.getBoundingClientRect().top;

			
			}

			function handleEnd(event) {
				// JackAuk lock Ios on potrait
				if ((getOperatingSystem()=="iPad" ||getOperatingSystem()=="Macintosh"|| getOperatingSystem()=="iPhone") && !isLandscapeIOS())
				{
					return;
				}

				var x = event.changedTouches[0].pageX - el.getBoundingClientRect().left;
				var y = event.changedTouches[0].pageY - el.getBoundingClientRect().top;

				if (isLocked)
				{
					event.preventDefault();
					var changedTouches = event.changedTouches;
					for (var i = 0; i < changedTouches.length; i++) {
						var touch = changedTouches[i];
						var index = getTouchActionIndex(changedTouches[i].identifier);
						if (index >= 0) {
							actionBtn = touchesAction[index].buttonId;
							touchesAction.splice(index, 1);
							doActionRelease(actionBtn);
							return;
						}
					}
				}

				if (isLocked)
				{	
					if (isPointInCircle(x, y, x_orig, y_orig, radius*3.0)) {
							//console.log("handleEnd - isInsideCircleExt");
							stopDrawingJoystick();
						}
				}				
			}

			function handleCancel(event) {
				// JackAuk lock Ios on potrait
				if ((getOperatingSystem()=="iPad" ||getOperatingSystem()=="Macintosh"|| getOperatingSystem()=="iPhone") && !isLandscapeIOS())
				{
					return;
				}

				console.log("Touch Cancel");
				if(false)
				arrowDisactiveAll();
				if (isLocked) {
					drawActionReleaseAll();
					if(!isMenuMode)
					stopDrawingJoystick();
				}
				//drawSwitchModeButton();
			}

			function getTouchIndex(id) {
				for (var i = 0; i < touches.length; i++) {
					if (touches[i].id === id) {
						return i;
					}
				}
				return -1;
			}

			function isInDpadRect(x, y) {
				if ((x > dpadArea[0][0].x) && (x < (dpadArea[0][2].x + arrowW))) {
					if ((y > dpadArea[0][0].y) && (y < (dpadArea[2][0].y + arrowh))) {
						return true;
					}
				}
				return false;
			}

			function isInActionRect(action, x, y) {
				if ((x > actionAreaMenu[action].x) && (x < (actionAreaMenu[action].x + actionAreaMenu[action].w))) {
					if ((y > actionAreaMenu[action].y) && (y < (actionAreaMenu[action].y + actionAreaMenu[action].h))) {
						return true;
					}
				}
				return false;
			}



			//----------------- Init page -----------------//
			function startup() {
				console.log('startup = ' + getOperatingSystem() + ", " + isLandscapeIOS() + ", " + browserDetect());
				loadImages();
				if (getOperatingSystem()=="iPhone") {
					if (isLandscapeIOS()) {
						if (browserDetect()=="safari") {
							initVariablesRatio(0.86);
							document.getElementById("dpadCanvas").style = "margin: 0; position: fixed; -ms-transform: translate(-45%, -42%); transform: translate(-45%, -42%);";
						} else {
							initVariablesRatio(0.88);
							document.getElementById("dpadCanvas").style = "margin: auto; position: fixed; top: 35px; bottom: 0; left: 0; right: 0;";
						}
						canvasH = canvasH-(canvasH*0.025);
						canvasW = canvasW-(canvasW*0.08);

					} else {
						initVariables();
						if (browserDetect()=="safari") {
							document.getElementById("dpadCanvas").style = "margin: 0; position: fixed; top: 50%; left: 50%; -ms-transform: translate(-50%, -50%); transform: translate(-50%, -50%);";
						} else {
							document.getElementById("dpadCanvas").style = "margin: auto; position: fixed; top: 0; bottom: 0; left: 0; right: 0;";
						}
					}
				} else if (getOperatingSystem()=="iPad"||getOperatingSystem()=="Macintosh") {
					initVariables();
					if (isLandscapeIOS()) {
						canvasH = canvasH-(canvasH*0.025);
						canvasW = canvasW-(canvasW*0.07);
						document.getElementById("dpadCanvas").style = "margin: 0; position: absolute; -ms-transform: translate(-45%, -42%); transform: translate(-45%, -42%);";
					} else {
						document.getElementById("dpadCanvas").style = "margin: 0; position: absolute; top: 50%; left: 50%; -ms-transform: translate(-50%, -42%); transform: translate(-50%, -42%);";
					}
				} else {
					initVariables();
				}
				initArray();
				currentWidth = canvasW;
				if ((getOperatingSystem()=="iPhone") && (browserDetect()=="chrome") && isLandscapeIOS()) {
					currentWidth = window.outerWidth;
				}
			}

			document.addEventListener("DOMContentLoaded",startup());
			document.addEventListener('visibilitychange', checkTabFocused());

			window.onload = function() {
				switch (document.readyState) {
					case "loading": //console.log("onload - The document is loading.");
						break;
					case "interactive": //console.log("onload - The document has finished loading and we can access DOM elements");
						break;
					case "complete":
						console.log("onload - The page is fully loaded");
						el.addEventListener("click", handleClick, false);
						el.addEventListener("touchstart", handleStart, false);
						el.addEventListener("touchmove", handleMove, false);
						el.addEventListener("touchend", handleEnd, false);
						el.addEventListener("touchcancel", handleCancel, false);
						el.addEventListener("touchstart", startDrawingJoystick);
						el.addEventListener("touchmove", DrawJoystick);
						if ((getOperatingSystem()=="iPad") || (getOperatingSystem()=="iPhone") || (getOperatingSystemIOS()=="iOS")|| (getOperatingSystemIOS()=="Macintosh")) {
							isLocked = true;
							drawButton();
							if (getOperatingSystem()=="iPad") {
								document.getElementById("dpadCanvas").style = "margin: 0; position: absolute; top: 50%; left: 50%; -ms-transform: translate(-50%, -42%); transform: translate(-50%, -42%);";
							}
						} else {
							drawRotateButton();
						}
						setInterval(updatePaint, 100);
						//setInterval(pingIn, 1000);
						setInterval(doActionInQueue, 10);
						ChangeUI(isMenuMode);
						break;
				}
			};

			/*if (window.performance) {
				if (performance.navigation.type === performance.navigation.TYPE_RELOAD) {
					//if ((getOperatingSystem()=="iPhone") && (browserDetect()=="chrome")) {
						//location.reload();
					//}
				} else {}
			}*/

			function checkTabFocused() {
			  if (document.visibilityState === 'visible') {
					if ((getOperatingSystem()=="iPhone") && (browserDetect()=="chrome")) {
						alert("aaa");
						if (isLandscapeIOS()) {
							document.getElementById("dpadCanvas").style = "margin: auto; position: absolute; top: 35px; bottom: 0; left: 0; right: 0;";
							checkResize();
						} else {
							document.getElementById("dpadCanvas").style = "margin: auto; position: absolute; top: 0; bottom: 0; left: 0; right: 0;";
						}
					}
				} else {
					document.getElementById("dpadCanvas").style = "margin: auto; position: absolute; top: 0; bottom: 0; left: 0; right: 0;";
				}
			}

			//----------------- Draw button -----------------//
			function loadImages() {
				//console.log('loadImages');
				//lockscreen button
				imgLockPortrait = new Image();
				imgLockPortrait.src = "images/lockPortrait.png";
				imgLockPortraitP = new Image();
				imgLockPortraitP.src = "images/LockPortraitP.png";
				//dpad button
				imgDpadBG = new Image();
				imgDpadBG.src = "images/dpadBG.png";
				imgDpadNormal = new Image();
				imgDpadNormal.src = "images/dpadNormal.png";
				imgDpadLeft = new Image();
				imgDpadLeft.src = "images/dpadLeft.png";
				imgDpadRight = new Image();
				imgDpadRight.src = "images/dpadRight.png";
				imgDpadUp = new Image();
				imgDpadUp.src = "images/dpadUp.png";
				imgDpadDown = new Image();
				imgDpadDown.src = "images/dpadDown.png";
				imgDpadUpLeft = new Image();
				imgDpadUpLeft.src = "images/dpadUpLeft.png";
				imgDpadUpRight = new Image();
				imgDpadUpRight.src = "images/dpadUpRight.png";
				imgDpadDownLeft = new Image();
				imgDpadDownLeft.src = "images/dpadDownLeft.png";
				imgDpadDownRight = new Image();
				imgDpadDownRight.src = "images/dpadDownRight.png";
				//Joystick button
				imgJoystickBG = new Image();
				imgJoystickBG.src = "images/joystickBG.png";
				imgJoystick = new Image();
				imgJoystick.src = "images/joystickNormal.png";
				//action button
				imgActionX = new Image();
				imgActionX.src = "images/respawn.png";
				imgActionY = new Image();
				imgActionY.src = "images/pause.png";
				imgActionA = new Image();
				imgActionA.src = "images/buttonA.png";
				imgActionB = new Image();
				imgActionB.src = "images/buttonB.png";
				imgActionXP = new Image();
				imgActionXP.src = "images/respawnP.png";
				imgActionYP = new Image();
				imgActionYP.src = "images/pauseP.png";
				imgActionAP = new Image();
				imgActionAP.src = "images/buttonAP.png";
				imgActionBP = new Image();
				imgActionBP.src = "images/buttonBP.png";
				// left L1, L2, right R1, R2
				imgActionL1 = new Image();
				imgActionL1.src = "images/buttonL1.png";
				imgActionL1P = new Image();
				imgActionL1P.src = "images/buttonL1P.png";
				imgActionR1 = new Image();
				imgActionR1.src = "images/buttonR1.png";
				imgActionR1P = new Image();
				imgActionR1P.src = "images/buttonR1P.png";
				imgActionL2 = new Image();
				imgActionL2.src = "images/buttonL2.png";
				imgActionL2P = new Image();
				imgActionL2P.src = "images/buttonL2P.png";
				imgActionR2 = new Image();
				imgActionR2.src = "images/buttonR2.png";
				imgActionR2P = new Image();
				imgActionR2P.src = "images/buttonR2P.png";
				//Start, Select
				imgStart = new Image();
				imgStart.src = "images/buttonStart.png";
				imgStartP = new Image();
				imgStartP.src = "images/buttonStartP.png";
				imgSelect = new Image();
				imgSelect.src = "images/buttonSelect.png";
				imgSelectP = new Image();
				imgSelectP.src = "images/buttonSelectP.png";


				imgDpadNormalA9= new Image();
				imgDpadNormalA9.src = "images/dpadBG.png";

			    imgDpadDownPressedA9 = new Image();
				imgDpadDownPressedA9.src =  "images/dpadDown.png";
				imgDpadLeftPressedA9 = new Image();
				imgDpadLeftPressedA9.src =  "images/dpadLeft.png";
				imgDpadRightPressedA9 = new Image();
				imgDpadRightPressedA9.src =  "images/dpadRight.png";
				imgDpadUpPressedA9 = new Image();
				imgDpadUpPressedA9.src =  "images/dpadUp.png";

				imgCamera  = new Image();
				imgCamera.src =  "images/camera.png";
				imgCameraP = new Image();
				imgCameraP.src =  "images/cameraP.png";
				imgTouchDrive = new Image();
				imgTouchDrive.src =  "images/touchdrive.png";
				imgTouchDriveP = new Image();
				imgTouchDriveP.src =  "images/touchdriveP.png";;


			}

			function drawButton() {
				//console.log('drawButton');
				if ((getOperatingSystem()=="iPad" ||getOperatingSystem()=="Macintosh"|| getOperatingSystem()=="iPhone") && !isLandscapeIOS())
					return;
				if (isLocked) {
					// drawDpad();
					drawActionButton();
					drawFunctionButton();
					joystickSize();
				}
			}

			function drawImageRotate(ct, imgID, posX, posY, imgW, imgH) {
				if ((getOperatingSystem()=="iPad") || (getOperatingSystem()=="Macintosh"&& isLandscapeIOS()) ||((getOperatingSystem()=="iPhone") && isLandscapeIOS()) || ((getOperatingSystem()=="Android"||getOperatingSystem()=="Desktop" ) && (canvasW>canvasH))) {
					ct.drawImage(imgID, Math.round(posX),  Math.round(posY),  Math.round(imgW),  Math.round(imgH));
				} else {
					ct.save();
					ct.translate(posX, posY);
					ct.rotate(90 * Math.PI / 180);
					ct.drawImage(imgID, 0, 0,  Math.round(imgW),  Math.round(imgH));
					ct.restore();
				}
			}
			function clearRotate( posX, posY, imgW, imgH) {
				if ((getOperatingSystem()=="iPad") || (getOperatingSystem()=="Macintosh"&& isLandscapeIOS()) || ((getOperatingSystem()=="iPhone") && isLandscapeIOS()) ||((getOperatingSystem()=="Android"||getOperatingSystem()=="Desktop" ) && (canvasW>canvasH))) {
					ctx.clearRect( Math.round( posX),  Math.round(posY),  Math.round(imgW),  Math.round(imgH));
				} else {
					ctx.save();
					ctx.translate(posX, posY);
					ctx.rotate(90 * Math.PI / 180);
					ctx.clearRect(0, 0,  Math.round(imgW),  Math.round(imgH));
					ctx.restore();
				}
			}
			function drawRotateButton() {
				//console.log("drawRotateButton - call");
				//ctx.fillStyle = "#080D11";
				//ctx.fillRect(0, 0, canvasW, canvasH);
				if (!isLocked) {
					let ctx = el.getContext("2d");
					let img = new Image();
					img.onload = function() {
						ctx.drawImage(img, actionAreaMenu[6].x, actionAreaMenu[6].y, actionAreaMenu[6].w, actionAreaMenu[6].h);
					}
					img.src = "images/lockPortrait.png";
				}
								// JackAuk lock Ios on potrait
				if ((getOperatingSystem()=="iPad" ||getOperatingSystem()=="Macintosh"|| getOperatingSystem()=="iPhone") && !isLandscapeIOS())
					{
						let ctx = el.getContext("2d");
					let img = new Image();
					img.onload = function() {
						ctx.drawImage(img, actionAreaMenu[6].x, actionAreaMenu[6].y, actionAreaMenu[6].w, actionAreaMenu[6].h);
					}
					img.src = "images/lockPortrait.png";
					}

			}

			function resizeCanvas() {
				debug.innerText = window.innerWidth + ", " + window.innerHeight;
				document.getElementById('dpadCanvas').width = window.innerWidth;
				document.getElementById('dpadCanvas').height = window.innerHeight;
				canvasW = document.getElementById('dpadCanvas').width;
				canvasH = document.getElementById('dpadCanvas').height;
			}

			function drawFunctionButton() {

			}

			function drawActionButton() {
				if(!isMenuMode){
						if (imgActionX.complete){
							drawImageRotate(ctx, imgActionX, actionAreaMenu[0].x, actionAreaMenu[0].y, actionAreaMenu[0].w, actionAreaMenu[0].h);
						} else {
							imgActionX.onload = function(){
								drawImageRotate(ctx, imgActionX, actionAreaMenu[0].x, actionAreaMenu[0].y, actionAreaMenu[0].w, actionAreaMenu[0].h);
							}
						}
						if (imgActionY.complete){
							drawImageRotate(ctx, imgActionY, actionAreaMenu[1].x, actionAreaMenu[1].y, actionAreaMenu[1].w, actionAreaMenu[1].h);
						} else {
							imgActionY.onload = function(){
								drawImageRotate(ctx, imgActionY, actionAreaMenu[1].x, actionAreaMenu[1].y, actionAreaMenu[1].w, actionactionAreaMenuArea[1].h);
							}
						}
						if (imgCamera.complete){
							drawImageRotate(ctx, imgCamera, actionAreaMenu[4].x, actionAreaMenu[4].y, actionAreaMenu[4].w, actionAreaMenu[4].h);
						} else {
							imgCamera.onload = function(){
								drawImageRotate(ctx, imgCamera, actionAreaMenu[4].x, actionAreaMenu[4].y, actionAreaMenu[4].w, actionAreaMenu[4].h);
							}
						}
						if (imgTouchDrive.complete){
							drawImageRotate(ctx, imgTouchDrive, actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionAreaMenu[5].h);
						} else {
							imgTouchDrive.onload = function(){
								drawImageRotate(ctx, imgTouchDrive, actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionactionAreaMenuArea[5].h);
							}
						}
					}

				if (imgActionA.complete){
					drawImageRotate(ctx, imgActionA,actionAreaMenu[2].x, actionAreaMenu[2].y, actionAreaMenu[2].w, actionAreaMenu[2].h);
				} else {
					imgActionA.onload = function(){
						drawImageRotate(ctx, imgActionA, actionAreaMenu[2].x, actionAreaMenu[2].y, actionAreaMenu[2].w, actionAreaMenu[2].h);
					}
				}
				if (imgActionB.complete){
					drawImageRotate(ctx, imgActionB, actionAreaMenu[3].x, actionAreaMenu[3].y, actionAreaMenu[3].w, actionAreaMenu[3].h);
				} else {
					imgActionB.onload = function(){
						drawImageRotate(ctx, imgActionB, actionAreaMenu[3].x, actionAreaMenu[3].y, actionAreaMenu[3].w, actionAreaMenu[3].h);
					}
				}
			}

			function drawDpad() {
				
			}

			

			//----- Action function -----
			function isInsideActionRect(pX, pY, id) {
				if ((getOperatingSystem()=="iPad")|| (getOperatingSystem()=="Macintosh"&& isLandscapeIOS())  || ((getOperatingSystem()=="iPhone") && isLandscapeIOS()) || ((getOperatingSystem()=="Android"||getOperatingSystem()=="Desktop" ) && (canvasW>canvasH))) {
					if ((pX > actionAreaMenu[id].x) && (pX < (actionAreaMenu[id].x + actionAreaMenu[id].w))) {
						if ((pY > actionAreaMenu[id].y) && (pY < (actionAreaMenu[id].y + actionAreaMenu[id].h))) {
							return true;
						}
					}
				} else {
					let x = actionAreaMenu[id].x-actionAreaMenu[id].h, y = actionAreaMenu[id].y;
					let w = actionAreaMenu[id].h, h = actionAreaMenu[id].w;
					if (pX > (x) && (pX < (x+w))) {
						if ((pY > y) && (pY < (y+h))) {
							return true;
						}
					}
				}
				return false;
			}

			function getTouchActionIndex(id) {
				//console.log("getTouchActionIndex - length: " + touchesAction.length);
				for (var i = 0; i < touchesAction.length; i++) {
					if (touchesAction[i].id === id) {
						//console.log("getTouchActionIndex - touchesAction i: " + i);
						return i;
					}
				}
				return -1;
			}

			function doActionPressed(id) {
				//console.log("doActionPressed: " + id);
				switch (id) {
					case 0: //KEYCODE_BUTTON_B
						sendActionDown(KEYCODE_BUTTON_B);
						actionAreaMenu[0].active=true;
						drawImageRotate(ctx, imgActionXP, actionAreaMenu[0].x, actionAreaMenu[0].y, actionAreaMenu[0].w, actionAreaMenu[0].h);
						break;
					case 1: //KEYCODE_BUTTON_START
						sendActionDown(KEYCODE_BUTTON_START);
						actionAreaMenu[1].active=true;
						drawImageRotate(ctx, imgActionYP, actionAreaMenu[1].x, actionAreaMenu[1].y, actionAreaMenu[1].w, actionAreaMenu[1].h);
						break;
					case 2: //KEYCODE_BUTTON_A
						if(isMenuMode)
						sendActionDown(KEYCODE_BUTTON_A);
						else
						sendActionDown(KEYCODE_BUTTON_X);

						actionAreaMenu[2].active=true;
						drawImageRotate(ctx, imgActionAP, actionAreaMenu[2].x, actionAreaMenu[2].y, actionAreaMenu[2].w, actionAreaMenu[2].h);
						break;
					case 3: //KEYCODE_BUTTON_B
						if(isMenuMode)
						sendActionDown(KEYCODE_BUTTON_B);
						else
						sendActionDown(KEYCODE_BUTTON_A);

						actionAreaMenu[3].active=true;
						drawImageRotate(ctx, imgActionBP, actionAreaMenu[3].x, actionAreaMenu[3].y, actionAreaMenu[3].w, actionAreaMenu[3].h);
						break;
					case 4: //KEYCODE_DPAD_DOWN
						sendDpadDown(KEYCODE_DPAD_DOWN);

						actionAreaMenu[4].active=true;
						drawImageRotate(ctx, imgCameraP, actionAreaMenu[4].x, actionAreaMenu[4].y, actionAreaMenu[4].w, actionAreaMenu[4].h);
						break;
					case 5: //KEYCODE_DPAD_UP
						sendDpadDown(KEYCODE_DPAD_UP);

						actionAreaMenu[5].active=true;
						isTouchDrive= !isTouchDrive;
						if(isTouchDrive)
						drawImageRotate(ctx, imgTouchDriveP, actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionAreaMenu[5].h);
						break;
					
				}
			}

			function doActionRelease(id) {
				//console.log("doActionRelease: " + id);
				switch (id) {
					case 0: //KEYCODE_DPAD_RIGHT_RELEASE
						sendActionUp(KEYCODE_BUTTON_B_RELEASE);
						actionAreaMenu[0].active = false;
						clearRotate( actionAreaMenu[0].x, actionAreaMenu[0].y, actionAreaMenu[0].w, actionAreaMenu[0].h);
						drawImageRotate(ctx, imgActionX, actionAreaMenu[0].x, actionAreaMenu[0].y, actionAreaMenu[0].w, actionAreaMenu[0].h);
						break;
					case 1: //KEYCODE_BUTTON_Y
						sendActionUp(KEYCODE_BUTTON_START_RELEASE);
						actionAreaMenu[1].active = false;
						clearRotate( actionAreaMenu[1].x, actionAreaMenu[1].y, actionAreaMenu[1].w, actionAreaMenu[1].h);
						drawImageRotate(ctx, imgActionY, actionAreaMenu[1].x, actionAreaMenu[1].y, actionAreaMenu[1].w, actionAreaMenu[1].h);
						break;
					case 2: //KEYCODE_BUTTON_A
						if(isMenuMode)
							sendActionUp(KEYCODE_BUTTON_A_RELEASE);
						else
							sendActionUp(KEYCODE_BUTTON_X_RELEASE);
						actionAreaMenu[2].active = false;
						clearRotate( actionAreaMenu[2].x, actionAreaMenu[2].y, actionAreaMenu[2].w, actionAreaMenu[2].h);
						drawImageRotate(ctx, imgActionA, actionAreaMenu[2].x, actionAreaMenu[2].y, actionAreaMenu[2].w, actionAreaMenu[2].h);
						break;
					case 3: //KEYCODE_BUTTON_B
						if(isMenuMode)
							sendActionUp(KEYCODE_BUTTON_B_RELEASE);
						else
							sendActionUp(KEYCODE_BUTTON_A_RELEASE);
						actionAreaMenu[3].active = false;
						clearRotate(  actionAreaMenu[3].x, actionAreaMenu[3].y, actionAreaMenu[3].w, actionAreaMenu[3].h);
						drawImageRotate(ctx, imgActionB, actionAreaMenu[3].x, actionAreaMenu[3].y, actionAreaMenu[3].w, actionAreaMenu[3].h);
						break;
					case 4: //KEYCODE_DPAD_DOWN_RELEASE
						sendDpadUp(KEYCODE_DPAD_DOWN_RELEASE);
						actionAreaMenu[4].active = false;
						clearRotate( actionAreaMenu[4].x, actionAreaMenu[4].y, actionAreaMenu[4].w, actionAreaMenu[4].h);
						drawImageRotate(ctx, imgCamera, actionAreaMenu[4].x, actionAreaMenu[4].y, actionAreaMenu[4].w, actionAreaMenu[4].h);
						break;
					case 5: //KEYCODE_DPAD_UP_RELEASE
						sendDpadUp(KEYCODE_DPAD_UP_RELEASE);
						actionAreaMenu[5].active = false;
						// clearRotate(  actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionAreaMenu[5].h);
						// drawImageRotate(ctx, imgTouchDrive, actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionAreaMenu[5].h);
						break;
					
				}
			}

			function drawActionReleaseAll() {
				//console.log("drawActionReleaseALL");
				//var ctx = el.getContext("2d");
				// drawImageRotate(ctx, imgActionX, actionArea[0].x, actionArea[0].y, actionArea[0].w, actionArea[0].h);
				// drawImageRotate(ctx, imgActionY, actionArea[1].x, actionArea[1].y, actionArea[1].w, actionArea[1].h);
				if(!isMenuMode)
				{
					drawImageRotate(ctx, imgActionX, actionAreaMenu[0].x, actionAreaMenu[0].y, actionAreaMenu[0].w, actionAreaMenu[0].h);
					drawImageRotate(ctx, imgActionY, actionAreaMenu[1].x, actionAreaMenu[1].y, actionAreaMenu[1].w, actionAreaMenu[1].h);
					drawImageRotate(ctx, imgCamera, actionAreaMenu[4].x, actionAreaMenu[4].y, actionAreaMenu[4].w, actionAreaMenu[4].h);
					drawImageRotate(ctx, imgTouchDrive, actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionAreaMenu[5].h);
				}
				drawImageRotate(ctx, imgActionA, actionAreaMenu[2].x, actionAreaMenu[2].y, actionAreaMenu[2].w, actionAreaMenu[2].h);
				drawImageRotate(ctx, imgActionB, actionAreaMenu[3].x, actionAreaMenu[3].y, actionAreaMenu[3].w, actionAreaMenu[3].h);

				for (var i=0; i<actionAreaMenu.length; i++) {
					actionAreaMenu[i].active=false;
				}
			}

			//----------------- Action -----------------//
			function arrowDisactiveAll() {
				if (dpadKeycodeCurrent != 0) {
					sendDpadUp(dpadKeycodeCurrent);
				}
				for (var i=0; i<3; i++) {
					for (var j=0; j<3; j++) {
						if (dpadArea[i][j].active) {
							dpadArea[i][j].active = false;
						}
					}
				}
				dpadKeycodeCurrent = 0;
			}

			function arrowActive(a, b) {
				arrowDisactiveAll();
				dpadArea[a][b].active = true;
			}

			function isArrowActive(a, b) {
				return dpadArea[a][b].active;
			}

			function arrowDisactive(a, b) {
				dpadKeycodeCurrent = 0;
				dpadArea[a][b].active = false;
			}

			function arrowActiveCount() {
				var count = 0;
				for (var i=0; i<3; i++) {
					for (var j=0; j<3; j++) {
						if (dpadArea[i][j].active == true){
							count += 1;
						}
					}
				}
				return count;
			}

			function actionActive(i) {
				if (actionAreaMenu[i].active){
					return true;
				}
				return false;
			}

			function actionActiveCount() {
				var count = 0;
				for (var i=0; i<6; i++) {
					if (actionAreaMenu[i].active == true){
						count += 1;
					}
				}
				return count;
			}

			//----------------- Joystick  -----------------//
			function joystickSize() {
				//console.log("joystickSize call");
				ctx.clearRect( dpadPosX-arrowW/2, dpadPosY-arrowH/2, arrowW*4, arrowH*4);
				//drawArrowJoystick(0);
				joystickBG();
				joystick(x_orig, y_orig);
			}

			function joystickBG() {
				if ((getOperatingSystem()=="iPad" ||getOperatingSystem()=="Macintosh"|| getOperatingSystem()=="iPhone") && !isLandscapeIOS())
					return;
				ctx.drawImage(imgJoystickBG, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
			}

			function joystick(width, height) {
				if ((getOperatingSystem()=="iPad" ||getOperatingSystem()=="Macintosh"|| getOperatingSystem()=="iPhone") && !isLandscapeIOS())
					return;
				ctx.drawImage(imgJoystick, width-1.14*radius, height-1.14*radius, radius*2.28, radius*2.28);
			}

			let coord = { x: 0, y: 0 };
			let paint = false;

			/*function getPosition(event) {
				var x = event.changedTouches[0].pageX - el.getBoundingClientRect().left;
				var y = event.changedTouches[0].pageY - el.getBoundingClientRect().top;
				coord.x = x;
				coord.y = y;
			}*/

			function isPointInCircle(x, y, cx, cy, radius) {
				var dx = x - cx,
					dy = y - cy,
					dist = Math.sqrt(dx * dx + dy * dy);
				if (dist < radius) {
				  return true;
				}
				return false;
			}

			function isInsideCircle() {
				var current_radius = Math.sqrt(Math.pow(coord.x - x_orig, 2) + Math.pow(coord.y - y_orig, 2));
				if (radius >= (current_radius))
					return true
				else
					return false
			}

			function isInsideCircleExt(radiusExt) {
				var dx = coord.x - x_orig,
					dy = coord.y - y_orig,
					dist = Math.sqrt(dx * dx + dy * dy);

				if (dist < radiusExt) {
				  return true;
				}
				return false;
			}

			function startDrawingJoystick(event) {
				if (isLocked) {
					coord.x = event.changedTouches[0].pageX - el.getBoundingClientRect().left;
					coord.y = event.changedTouches[0].pageY - el.getBoundingClientRect().top;
					if (isInsideCircleExt(radius*2)) {
						console.log("call --------- startDrawingJoystick");
						paint = true;
						if (isInsideCircle()) {
							joystickBG();
							joystick(coord.x, coord.y);
							DrawJoystick(event);
						}
					}
				}
			}

			function stopDrawingJoystick() {
				//console.log("call --------- stopDrawingJoystick");
				//drawArrowJoystick(0);
				paint = false;
				joystickBG();
				joystick(x_orig, y_orig);
				isSendDownJoyStick = false;
				sendJoystick(0, 0, 0, 0);
			}

			function DrawJoystick(event) {
				coord.x = event.changedTouches[0].pageX - el.getBoundingClientRect().left;
				coord.y = event.changedTouches[0].pageY - el.getBoundingClientRect().top;
				
				//ctx.arc(x_orig, y_orig, radius*3.0, 0, 2 * Math.PI);
				//if (paint && isPointInCircle(coord.x, coord.y, x_orig, y_orig, radius*3.0))				
				if (paint)
				{		
					ctx.clearRect( dpadPosX-arrowW/2, dpadPosY-arrowH/2, arrowW*4, arrowH*4);
					
					if (isInsideCircleExt(radius*3.0) && isPointInCircle(coord.x, coord.y, x_orig, y_orig, radius*3.0)) {
						console.log("call --------- DrawJoystick move handle - INSIDE");
						joystickBG();
						var angle_in_degrees,x, y, speed;
						var angle = Math.atan2((coord.y - y_orig), (coord.x - x_orig));

						if (Math.sign(angle) == -1) {
							angle_in_degrees = Math.round(-angle * 180 / Math.PI);
						}
						else {
							angle_in_degrees =Math.round( 360 - angle * 180 / Math.PI);
						}
						//console.log("angle_in_degrees:" +angle_in_degrees);

						// {
						// 	if(angle_in_degrees>=45&& angle_in_degrees<135) drawArrowJoystick(1);
						// 	else if(angle_in_degrees>=135&& angle_in_degrees<225) drawArrowJoystick(3);
						// 	else if(angle_in_degrees>=225&& angle_in_degrees<315) drawArrowJoystick(2);
						// 	else drawArrowJoystick(4);
						// }

						if (isInsideCircle()) {
							joystick(coord.x, coord.y);
							x = coord.x;
							y = coord.y;
						}
						else {
							x = radius * Math.cos(angle) + x_orig;
							y = radius * Math.sin(angle) + y_orig;
							joystick(x, y);
						}
						coord.x = event.changedTouches[0].pageX - el.getBoundingClientRect().left;
						coord.y = event.changedTouches[0].pageY - el.getBoundingClientRect().top;

						var speed =  Math.round(100 * Math.sqrt(Math.pow(x - x_orig, 2) + Math.pow(y - y_orig, 2)) / radius);
						var x_relative = Math.round(x - x_orig);
						var y_relative = Math.round(y - y_orig);
						sendJoystick(x_relative, y_relative, speed, angle_in_degrees);
						isSendDownJoyStick = true;
					} else {
						//if (!isPointInCircle(coord.x, coord.y, x_orig, y_orig, radius*3.3)) {
						console.log("call --------- DrawJoystick move handle - OUTSIDE");
						if (isInsideCircleExt(radius*5)) {
							var speed =  Math.round(100 * Math.sqrt(Math.pow(x - x_orig, 2) + Math.pow(y - y_orig, 2)) / radius);
							var x_relative = Math.round(x - x_orig);
							var y_relative = Math.round(y - y_orig);
							//console.log("Outside Circle - stopDrawingJoystick");
							sendJoystick(x_relative, y_relative, speed, angle_in_degrees);
							isSendDownJoyStick = true;
							stopDrawingJoystick();
						}
					}
				}
			}
			var isSendDownJoyStick = false;
			//----------------- Update paint -----------------//
			function updatePaint() {
				console.log("updatePaint canvasW " + canvasW + " canvasH " + canvasH);
				debug.innerText = window.innerWidth + ", " + window.innerHeight;
				if (window.outerWidth != currentWidth) {
					currentWidth = window.outerWidth;
					if (getOperatingSystem()=="iPhone") {
						if (isLandscapeIOS()) {
							if (browserDetect()=="safari") {
								initVariablesRatio(0.86);
								document.getElementById("dpadCanvas").style = "margin: 0; position: fixed; -ms-transform: translate(-45%, -42%); transform: translate(-45%, -42%);";
							} else {
								initVariablesRatio(0.88);
								document.getElementById("dpadCanvas").style = "margin: auto; position: fixed; top: 35px; bottom: 0; left: 0; right: 0;";
							}
							canvasH = canvasH-(canvasH*0.025);
							canvasW = canvasW-(canvasW*0.08);
							
						} else {
							initVariables();
							if (browserDetect()=="safari") {
								document.getElementById("dpadCanvas").style = "margin: 0; position: fixed; top: 50%; left: 50%; -ms-transform: translate(-50%, -50%); transform: translate(-50%, -50%);";
							} else {
								document.getElementById("dpadCanvas").style = "margin: auto; position: fixed; top: 0; bottom: 0; left: 0; right: 0;";
							}
						}
						initArray();
					} else if (getOperatingSystem()=="iPad" ||getOperatingSystem()=="Macintosh" ) {
						initVariables();
						if (isLandscapeIOS()) {
							canvasH = canvasH-(canvasH*0.025);
							canvasW = canvasW-(canvasW*0.07);
							document.getElementById("dpadCanvas").style = "margin: 0; position: absolute; -ms-transform: translate(-45%, -42%); transform: translate(-45%, -42%);";
						} else {
							document.getElementById("dpadCanvas").style = "margin: 0; position: absolute; top: 50%; left: 50%; -ms-transform: translate(-50%, -42%); transform: translate(-50%, -42%);";
						}
						initArray();
						drawButton();
					} else {
						initVariables();
						initArray();
						drawRotateButton();
					}
					//printDebug()
				}

				if (isLocked) {

					// JackAuk lock Ios on potrait

					if ((getOperatingSystem()=="iPad" ||getOperatingSystem()=="Macintosh"|| getOperatingSystem()=="iPhone") && !isLandscapeIOS())
						{
							drawRotateButton();
							return;
						}

					// if(isMenuMode)
					// {
					// //	ctx.clearRect( 0, 0, canvasW, canvasH);
					// 	ctx.clearRect( dpadPosX, dpadPosY, arrowW*3, arrowH*3);
						
					// 	if (arrowActiveCount() > 0) {
					// 		//console.log("updatePaint [dpad] active");
					// 		if (isArrowActive(0,0)) {
					// 			ctx.drawImage(imgDpadUpLeft, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 		} else if (isArrowActive(0,1)) {
					// 			ctx.drawImage(imgDpadUpPressedA9, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 		} else if (isArrowActive(0,2)) {
					// 			ctx.drawImage(imgDpadUpRight, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 		} else if (isArrowActive(1,0)) {
					// 			ctx.drawImage(imgDpadLeftPressedA9, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 		} else if (isArrowActive(1,1)) {
					// 			ctx.drawImage(imgDpadNormalA9, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 		} else if (isArrowActive(1,2)) {
					// 			ctx.drawImage(imgDpadRightPressedA9, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 		} else if (isArrowActive(2,0)) {
					// 			ctx.drawImage(imgDpadDownLeft, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 		} else if (isArrowActive(2,1)) {
					// 			ctx.drawImage(imgDpadDownPressedA9, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 		} else if (isArrowActive(2,2)) {
					// 			ctx.drawImage(imgDpadDownRight, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 		}
					// 	} else {
					// 		//console.log("updatePaint [dpad] normal");
					// 		// ctx.clearRect( dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 		ctx.drawImage(imgDpadNormalA9, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 		//ctx.drawImage(imgDpadNormal, dpadPosX, dpadPosY, arrowW*3, arrowH*3);
					// 	}
					// }  else{  // Action Phase
						//if (!joystickActive) {
							if (!paint) {
								clearRotate(actionAreaMenu[6].x, actionAreaMenu[6].y, actionAreaMenu[6].w, actionAreaMenu[6].h);
								joystickSize();
							} 
					//}// endof Ismenumode	
					//if (actionActiveCount() > 0)
					 {
						clearRotate(actionAreaMenu[0].x, actionAreaMenu[0].y, actionAreaMenu[0].w, actionAreaMenu[0].h);
						clearRotate(actionAreaMenu[1].x, actionAreaMenu[1].y, actionAreaMenu[1].w, actionAreaMenu[1].h);
						clearRotate(actionAreaMenu[2].x, actionAreaMenu[2].y, actionAreaMenu[2].w, actionAreaMenu[2].h);
						clearRotate(actionAreaMenu[3].x, actionAreaMenu[3].y, actionAreaMenu[3].w, actionAreaMenu[3].h);
						clearRotate(actionAreaMenu[4].x, actionAreaMenu[4].y, actionAreaMenu[4].w, actionAreaMenu[4].h);
						clearRotate(actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionAreaMenu[5].h);
						//console.log("updatePaint [action] active : " + actionActiveCount());
						// if (actionActive(0))
						// 	drawImageRotate(ctx, imgActionXP, actionArea[0].x, actionArea[0].y, actionArea[0].w, actionArea[0].h);
						// if (actionActive(1))
						// 	drawImageRotate(ctx, imgActionYP, actionArea[1].x, actionArea[1].y, actionArea[1].w, actionArea[1].h);
						if(!isMenuMode){
							if (actionActive(0))
								drawImageRotate(ctx, imgActionXP, actionAreaMenu[0].x, actionAreaMenu[0].y, actionAreaMenu[0].w, actionAreaMenu[0].h);
							else
								drawImageRotate(ctx, imgActionX,  actionAreaMenu[0].x, actionAreaMenu[0].y, actionAreaMenu[0].w, actionAreaMenu[0].h);
							if (actionActive(1))
								drawImageRotate(ctx, imgActionYP, actionAreaMenu[1].x, actionAreaMenu[1].y, actionAreaMenu[1].w, actionAreaMenu[1].h);
							else
								drawImageRotate(ctx, imgActionY,  actionAreaMenu[1].x, actionAreaMenu[1].y, actionAreaMenu[1].w, actionAreaMenu[1].h);

							if (actionActive(4))
								drawImageRotate(ctx, imgCameraP, actionAreaMenu[4].x, actionAreaMenu[4].y, actionAreaMenu[4].w, actionAreaMenu[4].h);
							else
								drawImageRotate(ctx, imgCamera,  actionAreaMenu[4].x, actionAreaMenu[4].y, actionAreaMenu[4].w, actionAreaMenu[4].h);
							
							if (isTouchDrive)
								drawImageRotate(ctx, imgTouchDriveP, actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionAreaMenu[5].h);
							else
								drawImageRotate(ctx, imgTouchDrive,  actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionAreaMenu[5].h);
						}

						if (actionActive(2))
							drawImageRotate(ctx, imgActionAP, actionAreaMenu[2].x, actionAreaMenu[2].y, actionAreaMenu[2].w, actionAreaMenu[2].h);
						else
							drawImageRotate(ctx, imgActionA,  actionAreaMenu[2].x, actionAreaMenu[2].y, actionAreaMenu[2].w, actionAreaMenu[2].h);
						if (actionActive(3))
							drawImageRotate(ctx, imgActionBP, actionAreaMenu[3].x, actionAreaMenu[3].y, actionAreaMenu[3].w, actionAreaMenu[3].h);
						else
							drawImageRotate(ctx, imgActionB,  actionAreaMenu[3].x, actionAreaMenu[3].y, actionAreaMenu[3].w, actionAreaMenu[3].h);

					}

				}
				//console.log("updatePaint E canvasW " + canvasW + " canvasH " + canvasH);
				//printDebug();
			}

			//----------------- Webpage -----------------//
			function isPortraitMode() {
				return screen.width < screen.height;
			}

			function isLandscapeMode() {
				return screen.width > screen.height;
			}

			function isPortraitIOS() {
				return (window.outerWidth < window.outerHeight);
			}

			function isLandscapeIOS() {
				return (window.outerWidth > window.outerHeight);
			}

			window.addEventListener( "orientationchange", function() {
				if ((getOperatingSystem()=="iPhone") && (browserDetect()=="chrome")) {
					//location.reload();
					if (isLandscapeIOS()) {
						//document.getElementById("dpadCanvas").style = "margin: 0; position: absolute; -ms-transform: translate(-45%, -46%); transform: translate(-45%, -46%)";
						document.getElementById("dpadCanvas").style = "margin: auto; position: absolute; top: 35px; bottom: 0; left: 0; right: 0;";
					} else {
					//	document.getElementById("dpadCanvas").style = "margin: auto; position: absolute; top: 0; bottom: 0; left: 0; right: 0;";
						//document.getElementById("dpadCanvas").style = "margin: 0; position: absolute; top: 50%; left: 50%; -ms-transform: translate(-50%, -50%); transform: translate(-50%, -50%);";
				
					}
				}

				paint = false;

			});
			window.addEventListener("resize", checkResize);

			function checkResize()
			{
				 if ((getOperatingSystem()=="iPhone"))
				 resizeCanvas();
				if (getOperatingSystem()=="iPhone") {
					if (isLandscapeIOS()) {
						if (browserDetect()=="safari") {
							initVariablesRatio(0.86);
						}
					}
				}
				else 	
					initVariables();
				initArray();

				var dx = actionAreaMenu[2].x - x_orig,
					dy = actionAreaMenu[2].y - y_orig,
					dist = Math.sqrt(dx * dx + dy * dy);

				if (dist < radius*2.5 || dx < 0) {
					clearAllScreen();
					drawRotateButton();
					isLocked=false;
					return false;
				}
				else isLocked =true;
				return true;
			}
			// window.addEventListener("focusin", function() {
			// 	initVariables();
			// 		initArray();
			// });

			window.addEventListener("focus", function() {
				initVariables();
					initArray();
				if (!isLocked) {

					if (browserDetect() != "opera")
						drawRotateButton();
				} else {
					drawButton();
				}
			});

			/* View in fullscreen */
			function lockFullscreen() {
				if (document.documentElement.requestFullscreen) {					/* Chrome */
					document.documentElement.requestFullscreen();
				} else if (document.documentElement.webkitRequestFullscreen) { /* Safari */
					document.documentElement.webkitRequestFullscreen();
				} else if (document.documentElement.msRequestFullscreen) { 		/* IE11 */
					document.documentElement.msRequestFullscreen();
				}
				screen.orientation.lock(screen.orientation.type).then(() => {
				}).catch((error) => {
					//console.log("Locked error: " + error);
				});

				if ((canvasW > canvasH) && (screen.orientation.type=="portrait-primary")) {
					screen.orientation.lock("landscape-primary");
					//screen.orientation.lock("portrait-primary");
				}

				console.log("lockFullscreen");
			}

			/* Close fullscreen */
			function closeFullscreen() {
				if (document.exitFullscreen) {
					document.exitFullscreen();
				} else if (document.webkitExitFullscreen) { /* Safari */
					document.webkitExitFullscreen();
				} else if (document.msExitFullscreen) { /* IE11 */
					document.msExitFullscreen();
				}
				screen.orientation.unlock();
			}

			document.addEventListener("fullscreenchange", onFullScreenChange, false);
			document.addEventListener("webkitfullscreenchange", onFullScreenChange, false);
			document.addEventListener("mozfullscreenchange", onFullScreenChange, false);

			function onFullScreenChange() {
				console.log("onFullScreenChange");
				//if (getOperatingSystem() == "Android"|| getOperatingSystem() == "Desktop")
				//	isLocked = !isLocked;
				if (!isLocked) {
					drawRotateButton();
				}
				initVariables();
				initArray();				
				drawButton();
			}
			screen.orientation.addEventListener("change", function() {
				initVariables();
				initArray();
				if (!isLocked) {
					clearAllScreen();
					drawRotateButton();
				} else {
					drawButton();
				}
				//checkResize();
			});

			//----------- device info -----------//
			function getOperatingSystem() {
				var userAgent = navigator.userAgent || navigator.vendor || window.opera;
				if (/android/i.test(userAgent))
					return "Android";
				if (/x86_64/i.test(userAgent))
					return "Desktop";
				if (/Macintosh/i.test(userAgent))
					return "Macintosh";
				if (/iPhone/.test(userAgent) && !window.MSStream)
					return "iPhone";
				if (/iPad/.test(userAgent) && !window.MSStream)
					return "iPad";
				return "unknown";
			}

			function getOperatingSystemIOS() {
				var userAgent = navigator.userAgent || navigator.vendor || window.opera;
				if (/android/i.test(userAgent))
					return "Android";
				if (/iPad|iPhone|iPod|Macintosh/.test(userAgent) && !window.MSStream)
					return "iOS";
				return "unknown";
			}

			function browserDetect() {
				let userAgent = navigator.userAgent;
				if(userAgent.match(/opr\//i)){
					return "opera";
				} else if(userAgent.match(/chrome|chromium|crios/i)){
					return "chrome";
				}else if(userAgent.match(/firefox|fxios/i)){
					return "firefox";
				}else if(userAgent.match(/safari/i)){
					return "safari";				
				}else if(userAgent.match(/edg/i)){
					return "edge";
				}else{
					 return "No browser detection";
				}
				//log('You are using ' + browserName + " browser");
			}

			function getChromeVersion () {
				var raw = navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./);
				return raw ? parseInt(raw[2], 10) : false;
			}

			//----------------- Debug -----------------//
			function drawTouchPoint(x, y) {
				ctx.beginPath();
				ctx.fillStyle = "red";
				ctx.fillRect(x, y, 2, 2);
			}

			function drawTouchPoint(x, y, color) {
				ctx.fillStyle = ""+color;
				ctx.fillRect(x, y, 2, 2);
			}

			//----------------------------------------------------//
			function printDebug() {
				var ratio = window.devicePixelRatio || 1;
				var w = screen.width;
				var h = screen.height;
				ctx.font="14px Comic Sans MS";
				ctx.fillStyle = "white";
				ctx.textAlign = "left";
				//ctx.fillText("v015", 0, canvasH-20);
				if (isLocked) {
					ctx.beginPath();
					ctx.arc(x_orig, y_orig, radius*3.0, 0, 2 * Math.PI);
					ctx.strokeStyle = "#00FF00";
					ctx.stroke();
					ctx.beginPath();
					ctx.beginPath();
					ctx.arc(x_orig, y_orig, radius*3.3, 0, 2 * Math.PI);
					ctx.strokeStyle = "#EAB676";
					ctx.stroke();
					ctx.beginPath();
					ctx.arc(dpadPosX+(arrowW*1.5), dpadPosY+(arrowW*1.5), (arrowW*1.5), 0, 2 * Math.PI);
					ctx.strokeStyle = "#FF0000";
					ctx.stroke();
					ctx.beginPath();
					ctx.arc(dpadPosX+(arrowW*1.5), dpadPosY+(arrowW*1.5), (arrowW*1.5)+12, 0, 2 * Math.PI);
					ctx.strokeStyle = "#CB4335";
					ctx.stroke();
				}
			}
				// Asphalt 9 mode
			function ChangeUI(mode)
			{
				clearAllScreen();
				drawBackground();
				if(isMenuMode==true)
				{
				   drawScreenMN();		
				}
				else
				{
				  drawScreenAP();	
				}
			}
			function ChangeUITouchDrive(enable)
			{
				console.log(enable);
				var m_isTouchDrive = false;
				if(enable == "TD_0")
					m_isTouchDrive=false;
				else if(enable == "TD_1")
					m_isTouchDrive = true;
				if(m_isTouchDrive!=isTouchDrive)
					{ 
						isTouchDrive= m_isTouchDrive;
						clearRotate(actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionAreaMenu[5].h);
						if (isTouchDrive)
							drawImageRotate(ctx, imgTouchDriveP, actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionAreaMenu[5].h);
						else
							drawImageRotate(ctx, imgTouchDrive,  actionAreaMenu[5].x, actionAreaMenu[5].y, actionAreaMenu[5].w, actionAreaMenu[5].h);
					}
			}
			function clearAllScreen()
			{
				ctx.clearRect( 0, 0, canvasW, canvasH);
			}
			function drawBackground()
			{
				// if (imgBG.complete){
				// 	drawImageRotate(ctx, imgBG,  0, 0, canvasW, canvasH);
				// } else {
				// 	imgBG.onload = function(){
				// 		drawImageRotate(ctx, imgBG,  0, 0, canvasW, canvasH);
				// 	}
				// }
			}
			function drawScreenMN()
			{
				imgActionA = new Image();
				imgActionA.src = "images/buttonA.png";
				imgActionB = new Image();
				imgActionB.src = "images/buttonB.png";
				imgActionAP = new Image();
				imgActionAP.src = "images/buttonAP.png";
				imgActionBP = new Image();
				imgActionBP.src = "images/buttonBP.png";
			}	
			function drawScreenAP()
			{
				imgActionA = new Image();
				imgActionA.src = "images/drift.png";
				imgActionB = new Image();
				imgActionB.src = "images/nitro.png";
				imgActionAP = new Image();
				imgActionAP.src = "images/driftP.png";
				imgActionBP = new Image();
				imgActionBP.src = "images/nitroP.png";
			}	
			function drawArrowJoystick(type)
			{
				switch (type)
				{
				case 0: 	if(imgJoystick.src != "images/joystickNormal.png")	{	imgJoystick.src = "images/joystickNormal.png";} break;
				case 1: 	if(imgJoystick.src != "images/joystickUp.png")		{	imgJoystick.src = "images/joystickUp.png";} break;
				case 2: 	if(imgJoystick.src != "images/joystickDown.png")	{	imgJoystick.src = "images/joystickDown.png";} break;
				case 3: 	if(imgJoystick.src != "images/joystickLeft.png")	{	imgJoystick.src = "images/joystickLeft.png";} break;
				case 4: 	if(imgJoystick.src != "images/joystickRight.png")	{	imgJoystick.src = "images/joystickRight.png";} break;
				}
			}
		</script>


</body>
</html>
